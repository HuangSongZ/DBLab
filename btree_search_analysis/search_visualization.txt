PostgreSQL B+树搜索可视化示例

场景：查找 key=75

树结构：
                        [50, 100]                    (Level 0: Root)
                       /    |     \
                      /     |      \
              [20,35]    [70,85]   [120]            (Level 1: Internal)
              /  |  \    /  |  \     |
             /   |   \  /   |   \    |
    [5,10,15] [20,25,30] [35,40,45] [50,55,60,65] [70,75,80] [85,90,95] [100,110,115]
                                                    (Level 2: Leaf)

搜索过程：

Step 1: 从根页面开始 (Block 0)
    ┌─────────────────┐
    │   [50, 100]     │
    │  /    |     \   │
    └─────────────────┘
    二分查找: 75 与 [50, 100] 比较
    - 75 > 50 ✓
    - 75 < 100 ✓
    → 选择 children[1] (Block 2)

Step 2: 下降到 Block 2
    ┌─────────────────┐
    │   [70, 85]      │
    │  /    |     \   │
    └─────────────────┘
    二分查找: 75 与 [70, 85] 比较
    - 75 > 70 ✓
    - 75 < 85 ✓
    → 选择 children[1] (Block 8)

Step 3: 到达叶子页 (Block 8)
    ┌─────────────────┐
    │  [70, 75, 80]   │  ← 叶子页
    └─────────────────┘
    二分查找: 75 与 [70, 75, 80] 比较
    - 75 > 70
    - 75 = 75 ✓
    → 找到位置 offset=1

父页面栈：
    Level 0: Block=2, Offset=1
    Level 1: Block=0, Offset=1

结果：
    ✓ 在 Block 8 的 offset 1 找到 key=75


并发分裂处理示例：

场景：查找 key=72，但页面已分裂

原始状态：
    Block 7: [50, 55, 60, 65, 70, 75, 80]  high_key=85

分裂后：
    Block 7: [50, 55, 60, 65]  high_key=70  right_link→8
    Block 8: [70, 75, 80]      high_key=85  right_link→9

搜索过程：
1. 跟随指针到达 Block 7
2. 检查 high_key: 72 > 70 ✗
3. 需要向右移动！
4. 跟随 right_link 到 Block 8
5. 检查 high_key: 72 < 85 ✓
6. 找到正确页面


二分查找详细过程：

在 Block 8: [70, 75, 80] 中查找 key=72

初始状态：
    low=0, high=4 (num_keys + 1)
    cmpval=1 (nextkey=false)

迭代1：
    mid = 0 + (4-0)/2 = 2
    compare(72, page[2]=80) = -8 < 1
    → high = 2

迭代2：
    mid = 0 + (2-0)/2 = 1
    compare(72, page[1]=75) = -3 < 1
    → high = 1

迭代3：
    mid = 0 + (1-0)/2 = 0
    compare(72, page[0]=70) = 2 >= 1
    → low = 1

结束：low=1, high=1
返回：offset=1 (第一个 >= 72 的位置，即 75)


关键概念图解：

1. Lehman & Yao 的 right-link 协议：
   ┌────┐ right  ┌────┐ right  ┌────┐
   │ P1 │───────→│ P2 │───────→│ P3 │
   └────┘        └────┘        └────┘
   high_key=50   high_key=100  (rightmost)

2. 内部页面的键范围：
   [K1=50, K2=100]
   /      |       \
   (-∞,50] (50,100] (100,+∞)

3. 父页面栈结构：
   ┌─────────────┐
   │ Block=0     │ ← Level 1 (根)
   │ Offset=1    │
   │ Parent=NULL │
   └──────┬──────┘
          │
   ┌──────▼──────┐
   │ Block=2     │ ← Level 0 (叶子的父)
   │ Offset=1    │
   │ Parent=↑    │
   └─────────────┘
